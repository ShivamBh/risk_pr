{% extends "base.html" %}
{% load static %}

{% block title %}{{ country.name }}- Detail {% endblock %}


{% block header %}
	<nav class="side-nav">
		<div class="nav-menu">
			<div class="nav-items">
				<a href="{% url "report_list" %}" class="nav-links">Reports</a>
			</div>
			<div class="nav-items">
				<a href="{% url "home" %}" class="nav-links">Countries</a>
			</div>
		</div>
	</nav>

{% endblock %}


{% block content %}

	<main class="container">
		
		<section class="header-wrapper">
			<div class="section-header">
				<h1>Dashboard</h1>
				<h1 class="nav-mob">Menu</h1>
			</div>
			<div class="search">
				<form action="{% url 'report_search' %}" id="search-form" method="get" accept-charset="utf-8" class="search-form">
					<button class="search-button" type="submit">
						<i class="fa fa-search" aria-hidden="true"></i>
					</button>
					<input type="text" class="search-field" id="searchbox" name="q" placeholder="Search">
					<div class="search-dropdown">

						<p>Advanced Search</p>
						<div class="dropdown-content">
							<p>Country</p>
							<input type="text" class="search-field" id="searchbox2" name="l" placeholder="Country">
							<p>Type of Report</p>
							<select name="t" id="search-type">
								<option value="T">Travel</option>
								<option value="C">Country</option>
								<option value="TC">Both</option>
							</select>
							<p>From Date<br class="form-break"> <input type="text" id="datepicker_from" name="fd" placeholder="From Date"></p>
							<p>To Date<br class="form-break"><input type="text" id="datepicker_to" name="td" placeholder="To Date"></p>
					
					</div>
					</div>
				</form>
			</div>
			<div class="user-settings">
				<a href="/logout/" class="profile-link">
				    <i class="fa fa-sign-out fa-2x icons" aria-hidden="true"></i>
				    
				</a>
				<a href="/profile/" class="profile-link">
					<i class="fa fa-user-circle fa-2x icons" aria-hidden="true"></i>
				</a>
			</div>

			
		</section>

		
		<div class="c-tabs no-js" id="tabs">
			<div class="c-tabs-nav">
				<a href="#" class="c-tabs-nav__link is-active">Full Report</a>
				<a href="#" class="c-tabs-nav__link" id="mapviewBtn">Map View</a>
			</div>

			<div class="c-tab is-active">
				<div class="c-tab__content">
					<section class="content-wrapper">

						<div class="main-content">

							<div class="country-detail-wrapper">
								<div class="country-intro">
									<h3>{{ country.name }}</h3>
								</div>

								<div class="ratings">
									<div class="country-wrap">
										<div class="country-ratings">
											<div class="country-rating-header">
												<h3>Country Ratings</h3>
											</div>
											<div class="country-rating-items">
												<div class="country-rating-item">
													<div class="rating-img political-rating">
														<img src="{% static 'img/red_thermo.svg' %}" alt="Political Rating">
														<span class="rating-span">{{ country.political_rating }}</span>
													</div>
													<div class="rating-text">
														<p>Political</p>
													</div>
												</div>
												<div class="country-rating-item">
													<div class="rating-img terror-rating">
														<img src="{% static 'img/yellow_thermo.svg' %}" alt="Terror Rating">
														<span class="rating-span">{{ country.terror_rating }}</span>
													</div>
													<div class="rating-text">
														<p>Terror</p>
													</div>
												</div>
												<div class="country-rating-item">
													<div class="rating-img security-rating">
														<img src="{% static 'img/orange_thermo.svg' %}" alt="Security Rating">
														<span class="rating-span">{{ country.security_rating }}</span>
													</div>
													<div class="rating-text">
														<p>Security</p>
													</div>
												</div>
												<div class="country-rating-item">
													<div class="rating-img travel-rating">
														<img src="{% static 'img/green_thermo.svg' %}" alt="Travel Rating">
														<span class="rating-span">{{ country.travel_rating }}</span>
													</div>
													<div class="rating-text">
														<p>Travel</p>
													</div>
												</div>
											</div>
										
										
										</div>
										<div class="country-rating-legend">
											<p class="co-leg-green">Green  :  Low</p>
											<p class="co-leg-yellow">Yellow :  Medium</p>
											<p class="co-leg-amber">Amber  :  High</p>
											<p class="co-leg-red">Red    :  Extreme</p>
										</div>
									</div>

									<div class="sec-wrap">
										<div class="sec-level-ratings">
											<div class="sec-level-item">
												<div class="sec-level-header">
													<h3>Security Preparedness Level</h3>
													<p class="sec-level-color">{{ country.sec_level }}</p>
												</div>
												<svg version="1.1" class="sec-level-svg" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 193.1 267.5" style="enable-background:new 0 0 193.1 267.5;" xml:space="preserve">
													<!-- <style type="text/css">
														
													</style> -->
													<path id="XMLID_2_" class="st0" d="M18.7,8.2c36.6-8.3,119-8.3,155.6,0c9.8,2.2,16.7,10.8,16.7,20.8v135.1c0,2.9-0.6,5.8-1.7,8.5
														c-12,28.3-53.9,77.2-83.6,91c-5.7,2.7-12.4,2.6-18.1-0.2c-30.2-14.6-72.5-63.5-84.1-91.6c-1-2.4-1.3-4.9-1.4-7.5L2,29.1
														C2,19.1,8.9,10.5,18.7,8.2z"/>
													<path id="shield-core" class="st1" d="M38.2,39.7c27.4-6.2,89.2-6.2,116.6,0c7.3,1.7,12.5,8.1,12.5,15.6v101.2c0,2.2-0.4,4.3-1.3,6.4
														c-9,21.2-40.4,57.8-62.7,68.1c-4.3,2-9.3,1.9-13.5-0.2c-22.6-11-54.4-47.6-63-68.6c-0.7-1.8-1-3.7-1-5.6L25.7,55.3
														C25.7,47.8,30.9,41.4,38.2,39.7z"/>
												</svg>
												

											</div>

											<div class="sec-level-legend">
												<div class="sec-row">
													<p>Green : Monitor</p>
													<p>Yellow : Review Security Posture</p>
												</div>
												<div class="sec-row">
													<p>Amber : Prepare Emergency Response Option</p>
													<p>Red : Adopt Emergency Response</p>
												</div>
												
												
											</div>
										</div>
								
								
									</div>
								
								
								
									</div>
									<div class="country-bg">
										<div class="country-bg-header">
											<h2>Country Background :</h2>
										</div>
										<div class="country-bg-text">
											<p>{{ country.risk_bg|safe }}</p>
										</div>
									</div>
									<div class="secondary-content secondary-country-page">

									
										<div class="main-header country-page">
											<h2 class="main-header-text country-page-header">Active Reports: </h2>
										</div>

										<div class="report-list">
											{% for report in rel_reps %}
												<div class="report-item">
													<div class="report-main">
														<div class="report-item-name">
															<h3>{{ report.title }}</h3>
														</div>

														<a href="{% url 'report_detail' pk=report.id %}" class="view-full">
														View
													</a>
													</div>
													
													<div class="report-meta">
														<div class="report-item-type">
															{% if report.report_type == "T" %}
																<p>Travel</p>
															{% else %}
																<p>Country</p>
															{% endif %}
														</div>
														<div class="report-item-loc">
															<p>{{ report.location.name }}</p>
														</div>	
														<div class="report-item-date">
															<p>{{ report.created_at }}</p>
														</div>
													</div>
													
												</div>
											{% endfor %}
										</div>
									</div>

								</div>
							</div>

					</section>
				</div>
			</div>
			<div class="c-tab">
				<div class="c-tab__content">
					<section class="map-view" id="mapview">
						<div class="maps-wrapper">
							
							<div class="country-map-area">
								<div id="country-maps"></div>
							</div>
							{% if rel_reps %}
							<div class="rel-reps">
								{% for report in rel_reps %}
									<span class="rel-name">{{ report.title }}</span>
									<span class="rel-cord">{{ report.latitude }} {{ report.longitude }}</span>
									<a href="{{ request.scheme }}://{{ request.get_host }}{% url 'report_detail' pk=report.id %}" class="rel-link">Rep link</a>
								{% endfor %}
							</div>
							{% endif %}
						</div>
					</section>
				</div>
			</div>
		</div>
	</main>


{% block load_js %}
	<script>
		$(document).ready(function() {
			$('#mapviewBtn').click(function() {
				$("#report-maps").delay('700').fadeIn();
				setTimeout(loadScript, 1000);
			});
		});

		function loadScript() {
			var script = document.createElement("script");
			script.type = "text/javascript";
			script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyBMySJy-jCub2jfs6z-cX5c6k55Ks3yRC4&callback=countryMap"
			document.body.appendChild(script);
		}

		function countryMap() {


			function getCoordinates(latLngList) {

				var i = 0;
				co_list = latLngList
				var arr = []
				
				for(i = 0; i < latLngList.length; i++) {
					var co_arr = [];
					var co_data = {};
					for(var j = 0; j < 1 ; j++) {
						co_data = {
							lat: Number(latLngList[i].innerHTML.split(" ")[j]),
							lng: Number(latLngList[i].innerHTML.split(" ")[j+1])
						};
					}
					arr.push(co_data);
				}

				return arr;

			}
			

			var latlng = document.querySelectorAll(".rel-cord");
			console.log(latlng);
			// var x = Number(latlng[1].innerHTML.split(" ")[0]);

			locList = getCoordinates(latlng);
			// console.log(locList[1].lat);

			var loc = locList[0];
			var mapOpts = {
				zoom: 3,
				center: loc,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};

			var map = new google.maps.Map(document.getElementById("country-maps"), mapOpts);
			var marker = new google.maps.Marker({position:loc});
			 marker.setMap(map);
			

			for( var i = 0; i < locList.length; i++ ) {
				var position = new google.maps.LatLng(locList[i].lat, locList[i].lng);

				
				//marker
				var marker = new google.maps.Marker({
					position: position,
					map: map
				});
				marker.setMap(map);

				//infowindow
				var infowindow  = new google.maps.InfoWindow({maxWidth: 180});

				//build content for infowindow
				var link = document.querySelectorAll(".rel-link")[i].href;
				var title = document.querySelectorAll(".rel-name")[i].innerHTML;
				var content = "<div class='info-window'><h3 class='info-window-text'>"+title+ "</h3>" +"<a class='info-window-link view-full' href='"+link+"'>View Report</a></div>"
				console.log(content);

				//call marker with infowindow and content
				google.maps.event.addListener(marker, 'click', (function(marker, content, infowindow) {
					return function() {
						
						infowindow.setContent(content);
						infowindow.open(map, marker);
					}
				})(marker, content, infowindow));
				// marker.addListener('click', function() {
				//     infowindow.open(map, marker);
				// });
			}

			google.maps.event.addDomListener(window, 'load', countryMap);

		google.maps.event.addDomListener(window, 'resize', function() {
		    var center = map.getCenter();
		    google.maps.event.trigger(map, 'resize');
		    map.setCenter(center);
		});

		}

		





	</script>

{% endblock %}

	<!-- Maps api -->
         <!-- <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBMySJy-jCub2jfs6z-cX5c6k55Ks3yRC4&callback=countryMap"
  type="text/javascript"></script> -->

	
{% endblock %}


